---
name: sat-dd
description: Specification-AI-Test Driven Development (SAT-DD) を実行するためのスキル。
---

# SAT-DD (Specification-AI-Test Driven Development)

新規実装、リファクタリング、フォルダ構成変更、仕様変更、バグ修正など、コードに変更を加える全てのタスクで遵守すべきプロセスを提供します。

## 目的 (Goal)
新機能の実装、リファクタリング、バグ修正など、コードを変更する全てのタスクにおいて、仕様（S）、実装（A）、テスト（T）を同期させ、変異テスト（M）によって品質を保証する。

## ルールと制約 (Rules & Constraints)
- 実装は`.agent/skills/gidline/SKILL.md`に従うこと。
- **【重要】**：同じStepを3回繰り返すたびにユーザーに継続するか確認を求めること。

## 作業手順 (Workflow)
### 事前準備 (Resources)
このプロセスを実行するために、以下のツール（スクリプト）が存在することを前提とします。
1.  **Marker:** 意図的なバグ混入を示す識別子 `// <MUTANT>` または `process.env.SAT_MUTATION_MODE`
2.  **Injector:** ファイルスワップ用スクリプト (例: `scripts/sat-inject.js`)
3.  **Guardian:** マーカー検知用スクリプト (例: `scripts/sat-guard.js`)

### 開発ワークフロー

### Step 1: Specification (S) - 要件定義と合意

1.  **要件分析:**
    * ユーザーからの指示および既存の `docs/*.md` 仕様書を分析する。
    * 論理的矛盾、既存仕様との不整合、技術的な懸念点があればこの時点で報告する。
2.  **仕様策定:**
    * 実装内容をまとめた要件定義を提案し`docs/*.md`の仕様書を作成または更新する。
    * ユーザーが提案を承認するまで要件定義を繰り返す。
3.  * 新規実装、または既存機能の外部から見た振る舞いが変わる修正の場合は**Step 1** へ進む。
    * 振る舞いを変えない内部最適化・リファクタリングの場合は**Step 2**へ進む。

### Step 2: Test Preparation (T) - テストファースト
4.   `.agent/skills/tdd-first/SKILL.md`を実行し仕様書を元にテストを作成する。既存機能の変更の場合は既存のテストを修正する。
5.  `npm run test:ai`を実行した後、`test-results.log`の内容を確認し、**全てのテストが「論理的に失敗（Red）」している**ことを確認する(※ コンパイルエラーではなく、アサーションエラーでの失敗を目指すこと)。全てのテストがエラーになっていない場合は4. のテストの作成からやり直す。
6.  全てのテストが論理的にエラー(Red)になったら**Step 3**に進む。

### Step 3: AI Implementation (A) - 実装

7.  `.agent/skills/tdd-fix/SKILL.md`を実行し、全てのテストをパス（Green）させるための最短の実装を行う。
8.  `npm run test:ai` を実行し全てのテストをパスしたら**Step 4**に進む。テストでエラーがでたら7.に戻る。

### Step 4: Optimization & Hardening - 最適化と厳格化
9.  `.agent/skills/tdd-strict/SKILL.md`を実行し、**Step3**で作成されたコードを検証し、コードを最適化する。
10. `.agent/skills/tdd-refine/SKILL.md`を実行してテストケースを厳格化する。
11. 再度`npm run test:ai` を実行し、全てのテストにパスするまで **Step 4** の最初から繰り返し品質を高める。全てのテストをパスしたら**Step 5**に進む。

### Step 5: Mutation Testing (M) - 意図的な破壊と検証
**⚠️ 最重要フェーズ: テストが「バグを見逃さないか」を検証する**

12. **Generate Mutant (バグ生成):**
    * 実装コードの複製を作成し、論理を反転させたり境界値をずらした「意図的なバグ」を混入させる。
    * **必須:** バグ箇所には必ずマーカー（`// <MUTANT>` 等）を付与する。
13. **Inject & Verify (注入と検証):**
    * `sat-inject` 等の手段を用い、正常なコードをバグ入りコード（Mutant）に一時的にスワップする。
    * テストを実行する。
        * ✅ **テスト失敗 (Red):** 成功。テストはバグを検知した。 -> **手順9へ**
        * ❌ **テスト成功 (Green):** 失敗。テストはバグを見逃した。 -> **コードを直ちに復元し、手順6（テスト強化）へ戻る**
14. **Revert (復元):**
    * スワップしたファイルを破棄し、正常なコード（バックアップ）に確実に書き戻す。

### Step 6: Safety Check (Guard) - 安全確認
15. **Run Guardian:**
    * プロジェクト全体に対して `sat-guard` スクリプトを実行する。
    * マーカー（`<MUTANT>`）の残留がないことを機械的に保証する。

### Step 7: Documentation Sync - 最終同期
16. 実装中に判明した仕様の細部や変更点を `docs/*.md` に最終反映する。
17. ユーザーに対し、実装内容と仕様書の変更点を報告し承認を得る。
