---
name: guideline
description: Next.js 16 + PWA + Local-First構成におけるアプリケーション実装ガイドライン。AIによる解釈性・保守性およびトークン効率（コンテキスト最適化）を最大化することを目的とします。
---

## 目的 (Goal)
本プロジェクトは Next.js 16 (App Router) + PWA + Local-First (Dexie.js) 構成において、AIによる解釈性・保守性およびトークン効率（コンテキスト最適化）を最大化することを目的とする。

## ルールと制約 (Rules & Constraints)


## 0.0 仕様の厳守と型安全性の絶対視 (Strict Adherence & Type Safety)
- **仕様の正当性**: 実装は `.md` 仕様書を正とする。矛盾がある場合は推測せず必ず確認する。
- **Single Source of Truth (SSOT)**:
  - **データ構造**: Zod Schema を正とする。型定義は `z.infer` で生成し、二重管理を防ぐ。
  - **DBスキーマ**: Dexie.js の定義を正とする。
- **Lint/Format**: Biome/ESLint エラーは許容しない。AIの修正リソースを浪費させないため常にクリーンに保つ。

## 0.1 構造化と粒度 (Semantic Granularity & Collocation)
- **機能単位のコロケーション (Feature-Sliced Design)**:
  - 関連するコンポーネント、フック、型は `app/` または `features/` 以下の同一ディレクトリに配置し、コンテキストの分散を防ぐ。
- **ドメインロジックの集約 (Domain Grouping in Lib)**:
  - データベースや認証など、特定の責務を持つロジックは `lib/` 直下に散乱させず、専用ディレクトリ（例: `lib/db/`）にカプセル化する。
  - **推奨構成**:
    - `index.ts`: 初期化・エントリポイント
    - `schema.ts`: Zodスキーマ・型定義・データ変換
    - `operations.ts`: CRUD操作・ロジック
    - `*.test.ts`: 同一ディレクトリ内にテストを配置
- **ファイル分割基準**:
  - 1ファイル 100〜200行を目安とするが、「Server/Client Component の境界」での分割を最優先する。
  - `"use client"` はインタラクションを含む最小範囲に留める。

## 0.2 独立性と自己完結性 (Context Autonomy)
- **明示的な依存関係**:
  - ワイルドカードインポート (`import *`) およびバレルファイル (`index.ts` による全エクスポート) は原則禁止。AIのコンテキスト汚染を防ぐため、必要なものだけを具体的にインポートする。
- **純粋性と副作用の排除**:
  - コンポーネントは外部スコープに依存させない。グローバルステート（Zustand等）は専用フックに閉じ込め、実装詳細を隠蔽する。

## 0.3 定義と実装の分離 (Skeleton & Implementation)
- **インターフェース先行**:
  - 複雑なロジックは先に関数のシグネチャとJSDocを定義する。AIがインターフェースのみで結合を推論できるようにする。
- **UIとロジックの分離**:
  - データ取得（TanStack Query/Dexie）と表示（Tailwind）を分ける。
  - 複雑なTailwindクラスは可読性を維持するため、適切に改行またはコンポーネント化する。

## 0.4 高密度な記述とドキュメンテーション (Token Density & Context)
- **Why/Context指向のコメント**:
  - 「What」はコードで語る。「Why（なぜNext.jsのこの機能を使うか、なぜオフライン対応が必要か）」を記述する。
- **JSDocによる意味付け**:
  - エクスポートする関数・型には必ず JSDoc を付与する。これはAIのための最強のコンテキスト源となる。
- **デッドコード排除**:
  - 未使用コード、コメントアウト、装飾ラインは即時削除し、AIのハルシネーションを防ぐ。