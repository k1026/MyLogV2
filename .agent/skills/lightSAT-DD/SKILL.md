---
name: light-sat-dd
description: 新規実装、リファクタリング、フォルダ構成変更、仕様変更、バグ修正など、コードに変更を加える全てのタスクで遵守すべきプロセスを提供します。
---

# 目的 (Goal)
コードの安定性を保ちプロジェクトの品質を保証すること。

# ルールと制約 (Rules & Constraints)
- **【重要】**：各ステップの実行回数を記録し、同じStepを3回繰り返すたびにユーザーに継続するか確認を求めること。
- テストファイルは実装コードと同じフォルダに作成すること。
- 一度に全てのステップを読み込まずに段階的に必要なステップのみ読み込んで処理すること
- 必要な場合は`docs/specs/`内の関連する仕様書を参照すること

# 実装ワークフロー

## Step 1: 選択
- 新規実装、または既存機能の外部から見た振る舞いが変わる修正の場合は**Step 2** のテストの作成に進む。振る舞いを変えない内部最適化・リファクタリングの場合は**Step 4**の実装に進む。

## Step 2: テスト作成

1. 下記のルールに従いテストを作成し**Step 3**に進む
    - 実装ファイル（.ts）に関数名と型定義のみの「空実装」を作成し、テストコードは公開インターフェース経由で論理検証により「振る舞いの検証」を行い、「空実装」に対しては必ず「失敗（Red）」する論理構造であること。
    - テスト間で状態を共有せず、高速に並列実行できる構成を維持すること
    - テストパターンは、最小値(min)、最大値(max)、無効値(null/empty)などの境界値で網羅的に行い、`if/else` のすべての分岐を最小限のケースで通るように整理すること
    - 同じ操作を繰り返しても副作用がないか確認すること    
    - DB操作は全て `await` を徹底し、`beforeEach` でのテーブルクリアを含めること


## Step 3: テスト実行
2.  `npm run test:ai`コマンドでテストを実行し、`test-results.log`の内容を確認し、**全てのテストが「論理的に失敗（Red）」している**ことを確認する

3. 全てのテストが論理的にエラー(アサーションエラー)になっていれば**Step 4**の実装に進む。そうでない場合は **Step2** のテストの作成からやり直す。

## Step 4: 実装
4. `any` を一切使わず、Strictな型を維持したまま、テストをパスさせるためのコードの実装・修正を実施する。

5.  `npm run test:ai`コマンドでテストを実行し、`test-results.log`の内容を確認し全てのテストをパスしたら**Step 5**に進む。テストでエラーが出た場合は 4. の実装に戻る。

## Step 5: 最適化と厳格化
6.  **Step 4**で変更したコードに対してコード規約に準拠するように修正し、AIによる可読性や処理効率を最適化する。

7. 実装コードに関連する全てのテストに対して批判的視点で評価し、堅牢性と実施効率を高めるように修正する。必要に応じてテストを整理する。

8. `npm run test:ai`コマンドでテストを実行し、`test-results.log`の内容を確認し、全てのテストをパスしたら**Step 6**に進む。テストでエラーが出た場合は 6. に戻る。

## Step 6: 最終確認
9. ユーザーに対し、実装内容と実装毎の各ステップの試行回数を報告する。
