# 3. データベース仕様

このドキュメントでは、アプリケーションが使用するローカルデータベースの構成とデータ構造について記述します。
本システムでは、IndexedDBのラッパーライブラリとして **Dexie.js** を採用し、データ整合性は **Zod** スキーマによって管理します。

## 基本構成

| 項目 | 値 | 説明 |
| :--- | :--- | :--- |
| **DB Name** | `MyLogV2DB` | データベース名 |
| **Version** | `1` | DBバージョン |
| **Library** | Dexie.js | ORM / ラッパー |
| **Store Name** | `cells` | データを格納するテーブル名 |

## スキーマ定義 (Dexie.js)

Dexie.jsの `stores` 定義に基づきます。SQLのような厳密なカラム定義ではなく、インデックス（検索・ソート対象）のみを定義します。

- **Type**: `Dexie.js Schema`
- **Definition**: `'&I'`
- **Auto Increment**: `false` (IDはアプリケーション側で生成)

### インデックス設定

| インデックス記号 | キーパス | ユニーク | 説明 |
| :--- | :--- | :--- | :--- |
| `&` | `I` | true | **Primary Key**。Cellの一意な識別子。 |

> **Note:** `A` (Attribute) や `R` (Remove) などのフィールドは、現在の検索要件ではインデックス化していませんが、将来的なフィルタリング要件に応じて定義に追加可能です。

## データマッピング

ストレージ容量の節約のため、DB保存時にはプロパティ名を短縮形（1文字）にマッピングします。
アプリケーション層（TypeScript/Zod）と永続化層（Dexie）の間で、リポジトリ層が相互変換を行います。

### マッピングテーブル

| DBキー | アプリ内プロパティ | 型 (TS) | 説明 |
| :--- | :--- | :--- | :--- |
| `I` | `id` | `string` | 一意なID (Timestamp + Random) |
| `A` | `attribute` | `string` | セルの種類 ('Card', 'Time', 'Text', 'Task') |
| `N` | `name` | `string` | セルの名前/タイトル |
| `V` | `value` | `string` | セルの値 |
| `G` | `geo` | `string \| null` | 位置情報 (緯度,経度,高度) |
| `R` | `remove` | `string \| null` | 削除フラグ (削除時のタイムスタンプ文字列) |

> **型の整合性:** アプリケーション内でのデータ型は `zod` スキーマを唯一の定義元（Single Source of Truth）とします。
## 操作インターフェース

データベース操作は `lib/db/operations.ts` が提供する `CellRepository` オブジェクトを通じて行います。
すべてのメソッドは `Promise` を返し、型安全な `Cell` オブジェクトを入出力します。

- **`open()`**:
  データベース接続を確立する。
- **`save(cell)`**:
  `Cell` オブジェクトを受け取り、DB形式(`I`, `A`...)に変換して保存または更新(Upsert)する。
- **`getById(id)`**:
  IDを指定して特定のセルを取得し、`Cell` オブジェクト形式に変換して返す。
- **`getByIds(ids)`**:
  IDの配列を指定して複数のセルを一括取得する。
- **`getAll()`**:
  すべてのセルをIDの降順（新しい順）で取得する。
- **`delete(id)`**:
  IDを指定してセルを物理削除する。
- **`clearAll()`**:
  ストア内の全データを削除する。
- **`getCount()`**:
  保存されているセルの総数を取得する。
- **`getRange(offset, limit)`**:
  ページネーションのために範囲指定で取得する（ID降順）。
- **`getAllKeys(direction)`**:
  保存されている全データのキー(ID)のみを取得する。`direction`で順序指定可能('next'|'prev')。
- **`processAllInBatches(batchSize, callback)`**:
  全データをバッチサイズごとに分割して処理する。
  - Dexieの `Collection.each` を使用し、メモリ効率良く処理を行う。
  - トランザクション内で実行され、大量データのバックグラウンド処理に適する。


## ファイル入出力

バックアップおよび外部連携のために、以下の仕様でファイル入出力をサポートします。

- **フォーマット**: JSONL (JSON Lines)
  - 各行が有効なJSONオブジェクトであることを保証します。
  - エンコーディングは UTF-8 とします。

- **データ構造**: DB内部のデータ形式 (`CellDB`)
  - DB内部の短縮キー (`I`, `A`...) をそのまま使用します。
  - プロパティ名のマッピング変換コストを排除し、ファイルサイズを最小化します。

- **提供インターフェース**:
  - **`exportAsJSONL(): Promise<string>`**:
    - DBから生データを取得し、そのままJSONL形式の文字列として生成します。
  - **`importFromJSONL(jsonl: string): Promise<ImportResult>`**:
    - JSONL形式のデータを読み込みます。
    - **変換と検証**: 各行を `CellDB` 形式としてパースした後、アプリケーション層の `Cell` オブジェクトへ変換 (`mapFromDB`) し、`Zod` スキーマで検証を行います。
    - **保存**: 検証に通過したデータをDBに保存（Upsert）します。
    - **エラーハンドリング**: 無効な行はスキップし、処理結果（成功数、失敗数、エラー詳細）を返します。

## 対応予定

Next.js 16 で PWA を構築する場合、ブラウザのキャッシュや Service Worker が IndexedDB の挙動に干渉することが稀にあります。

考慮点: 開発中の「ホットリロード」時に DB インスタンスが二重に生成されないよう、db.ts でシングルトンパターン（既存の接続があればそれを使う）を徹底させる必要があります。