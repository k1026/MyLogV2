# 7. カードリストUI (Card List UI)

カードリストUIは、アプリケーションのメインビューであり、データベース内のCardセルを一覧表示するためのUI

## 7.0 デザイン
- カードリストはライトテーマ

## 7.1 基本構成
- **コンテナ**: 画面全体を使用しヘッダーとフッターの間に配置
- **表示モード**: リストビュー (`view-list`)：カードUIを通常表示で1列に並べて表示

## 7.2 データソース
- **データソース**：IndexedDBから取得したCellの中から`attribute`が`Card`であるものを抽出し表示対象とする
- **フィルタリング**：フィルタリング機能によって絞り込まれた`Card`のみを表示対象とする
  - フィルタリングがOFFの場合は全ての`Card`を対象とする

## 7.3 表示要素
- **カードアイテム**：表示するカードをカードUIの折りたたみ状態で表示する
- **Empty State**：表示するカードがないorフィルタに一致するカードがない場合には「表示するカードがありません」という文字列を表示する


## 7.4 インタラクション
- **カードUIのクリック (Tap)時の動作**：
  - **位置調整** 
    **展開時**：カードUIを展開した場合はそのカードUIの上部が画面上部に揃うように表示位置を調整してから展開する
    **折りたたみ時**：カードUIを折りたたむときは画面やリストが動かないように調整する
    　- 画面内のカードUIを折りたたむ場合はその位置で折りたたむ
      - 画面外のカードUIを折りたたむ場合は現在のリスト表示が動かないように調整する
  - **スクロール制限**
    **展開時**：カードUIを展開している場合はカードリストUIのスクロール範囲をそのカードUIの描画範囲に制限する
      - カードUIが見きれないようスクロール範囲には少し余裕をもたせる
    　- カードUIを閉じたら制限を解除する

## 7.5 パフォーマンス最適化
### 7.5.0 更新画面
- 更新処理が1秒を越えた時点で読み込みアニメーションを表示する
### 7.5.1 初期ロード最適化
- アプリ起動時の待機時間を最小化するため、以下の段階的な読み込みを行う
  1. **初回バッチ(1000件)**: 
     - 読み込み完了直後にUIを描画し、スプラッシュスクリーンを非表示にして操作可能にする
     - この段階で統計計算（Rarity等）の初回分を行う
  2. **バックグラウンド読み込み**:
     - 残りのデータはバックグラウンドで1000件ずつ読み込む
     - 読み込み中は内部データの蓄積のみを行う（DBアイコンはLoading表示）
     - ユーザーへのフィードバックとして、ヘッダーのCard/Cell件数のみリアルタイム更新する
  3. **完了処理**:
     - 全データ読み込み完了後、一括でソートとリストの更新（整合）を行う

### 7.5.2 仮想スクロール (Virtual Scroll)
- 大量のデータを扱うため、画面内に表示される範囲（および前後のバッファ）のみをDOMとして描画します。
- スクロール位置に応じて動的にDOM要素を入れ替えることで、大量のデータがあってもスムーズなスクロールを実現
- **描画単位**：一度に読み込むのは対象となる90件のカードまで
  →90件のカードを30件ずつ前中後の3つ分け、スクロールに応じて読み込む範囲を変える

### 7.5.3 リストの更新と描画
- **部分更新**：カードの追加や編集、除外が行われた際は部分更新を実施し全体の更新は行わない
  - **部分更新の範囲**：部分更新はリストの描画単位の範囲に対してのみ実施し、ソートや描画の更新を行う
- **更新の制限**：カードUIの展開中はリストの更新を待機し、カードUIを閉じたあとに更新を行う


## 7.6 リストのソート
- **基準**：カードリストのソートは時間順とし、各カードの時間はカードに含まれる一番新しいセルのタイムスタンプを使用する
  →セルを含まないカードの場合はカード自体のタイムスタンプを使用する
- **順序**：降順(新しい順)をデフォルトとし、フッターのソートボタンで切り替え
- **再ソートの最適化**：
  - **追加時**：新規カード追加時はリスト全体の再ソートを行わず、ソート順序に従って適切な位置に挿入することでパフォーマンスを維持する
  - **編集時**：セルの編集終了（カードを閉じる）タイミングで、表示範囲（描画単位）に含まれるカードのみを対象に再ソートを実行し、即座に順序を整列させる
  - **全体更新**：フィルタ変更や一括読み込み完了時など、リスト全体に影響がある場合は全体のソートを行う

## 7.7 カード追加ボタン
**機能**：新しいCardを生成してカードリストに追加し表示する。追加したカードは展開状態で表示する。
**配置**：カードリストの右下。
**デザイン**：
  - 四角のフローティングボタン
  - 白色で中央に紫の十字マーク
  - 角の丸め16px
  - 枠線の色：rgba(149, 117, 205, 0.3) （薄い紫色）
**挙動**画面スクロールに併せてフローティングし常に画面じょうに表示される。リスト内のカードを開くとボタンを非表示にし、カードを閉じると表示する。
