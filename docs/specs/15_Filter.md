# 15 フィルタ機能仕様書

# レイアウト
- **[全体]**：垂直 (ダイアログ)
  - **[ヘッダー]**：水平
    - 🔍 アイコン (Filter)
    - 🔤 タイトル (Filter Settings)
    - ❌ 閉じるボタン
  - **[コンテンツ]**：垂直
    - **[属性セクション]**：垂直
      - 🏷️ ラベル (属性選択)
      - **[ボタンエリア]**：水平
        - 🔘 属性ボタン(Text)
        - 🔘 属性ボタン(Task)
        - 🔘 属性ボタン(Remove)
    - **[抽出セクション]**：垂直
      - 🏷️ ラベル (キーワード抽出)
      - **[入力エリア]**：水平
        - 🔍 検索入力
        - 🔄 対象切替ボタン
    - **[除外セクション]**：垂直
      - 🏷️ ラベル (キーワード除外)
      - 🔍 除外入力
    - **[期間セクション]**：垂直
      - 🏷️ ラベル (期間フィルタ)
      - **[入力エリア]**：水平
        - 📅 開始日入力
        - ～ (セパレータ)
        - 📅 終了日入力
        - 🔄 期間リセットボタン
  - **[フッター]**：水平
    - 🔄 リセットボタン
    - ✅ 適用するボタン

# デザイン

## 共通仕様
**名称**：ダイアログコンテナ、
**種類**：モーダルダイアログ、
**用途**：フィルタ条件の設定、
**形状**：角丸(2.5rem)、
**寸法**：最大幅 448px (max-w-md)、
**文字**：Inter/Outfit (標準フォント)、
**色彩**：紫系グラデーション (from-purple-600 via-purple-700 to-indigo-800)、
**装飾**：境界線 (white/20)、シャドウ (2xl)、背景ぼかし (backdrop-blur-sm)、
**配置**：画面中央、
**状態**：フェードイン・ズームインアニメーション、
**挙動**：背景クリックで閉じる、

## 属性ボタン
**名称**：属性選択ボタン、
**種類**：トグルボタン、
**用途**：フィルタ対象の属性（Text/Task/Remove）の切り替え、
**形状**：角丸(1rem)、
**寸法**：高さ 48px (py-3)、
**文字**：太字、サイズ 14px (text-sm)、
**色彩**：有効時（白背景、紫文字 #7e22ce）、無効時（白/10背景、白/50文字）、
**装飾**：枠線 1px (white/40)、有効時シャドウ(lg)、
**配置**：水平均等配置 (flex-1)、間隔 8px、
**状態**：ホバー時に背景透過度変更、
**挙動**：タップで状態反転、

## 入力エリア
**名称**：キーワード入力、
**種類**：テキスト入力、
**用途**：検索・除外キーワードの入力、
**形状**：角丸(1rem)、
**寸法**：高さ 48px (py-3)、
**文字**：サイズ 16px、
**色彩**：白/10背景、白文字、プレースホルダ（白/30）、
**装飾**：枠線 1px (white/20)、
**配置**：左側にアイコン (Search)、
**状態**：フォーカス時に枠線強調 (white/50)、
**挙動**：テキスト入力、

## 期間入力
**名称**：日付入力、
**種類**：date input、
**用途**：検索期間の指定、
**形状**：角丸(1rem)、
**寸法**：高さ 48px (py-3)、
**文字**：サイズ 14px (text-sm)、
**色彩**：白/10背景、白文字、
**装飾**：枠線 1px (white/20)、color-scheme: dark (カレンダーUI用)、
**配置**：2つを水平配置、間に「～」、
**状態**：、
**挙動**：ブラウザ標準の日付選択UI、

## フッターボタン
**名称**：アクションボタン、
**種類**：プッシュボタン、
**用途**：設定のリセットまたは適用、
**形状**：角丸(1rem)、
**寸法**：高さ 56px (py-4)、
**文字**：太字、
**色彩**：適用（白背景、紫文字）、リセット（白/10背景、白文字）、
**装飾**：適用ボタンのみシャドウ(xl)、
**配置**：水平配置、リセット(1)：適用(2)の比率、
**状態**：ホバー時に背景色変更、
**挙動**：タップで設定を確定または初期化、

## ハイライト
**名称**：キーワード強調、
**種類**：テキスト装飾、
**用途**：抽出キーワードに一致する箇所の可視化、
**形状**：角丸(0.125rem)、
**寸法**：左右パディング 2px (px-0.5)、
**文字**：インヘリト (親要素の太さ・サイズを維持)、
**色彩**：オレンジ背景 (bg-orange-200)、
**装飾**：、
**配置**：、
**状態**：、
**挙動**：、

# ロジック仕様

## デフォルト設定
- **有効属性**: `['Text', 'Task']`
- **キーワード**: 抽出・除外ともに空
- **キーワード対象**: `both` (名前と値の両方)
- **期間**: 指定なし (`null`)

## フィルタリングプロセス (`filterCards`)
1. **削除判定**:
   - `Remove` 属性が選択されていない場合、`remove` フラグがあるカードを即座に除外。
2. **属性一致判定**:
   - 選択された属性（Text, Task）のいずれかを持つサブセルが、カード内に1つ以上存在するかを判定。一致しない場合は除外。
3. **期間一致判定**:
   - 期間が指定されている場合、いずれかのサブセルのタイムスタンプが範囲内であれば一致。範囲外のみの場合は除外。
4. **キーワード除外（優先）**:
   - 除外キーワードのいずれかが、サブセルの指定対象（名前/値/両方）に含まれる場合、そのカードを除外。
5. **キーワード抽出**:
   - 抽出キーワードのいずれかが、サブセルの指定対象に含まれる場合、そのカードを保持。キーワードが指定されている場合は、一致しないカードを除外。

## キーワードハイライト
- `filterSettings.keywords.include` に含まれるキーワード（大文字小文字を区別しない）を対象とする。
- 正規表現を用いて特殊文字をエスケープし、一致する箇所を `<mark>` タグで囲む。
- 入力欄（TextCell, TaskCell）が非フォーカスの場合、およびカードプレビューで適用される。
