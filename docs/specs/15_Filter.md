# 15 フィルタ機能仕様書

## 15.1 概要
カードを条件に基づいて絞り込む機能。フッターのフィルタボタンからアクセスし、専用のダイアログで条件を設定する。フィルタはメイン画面のカードリストに対して適用される。

## 15.2 UI・インターフェース

### 15.2.1 フィルタボタン（フッター）
- **場所**: フッターの中央セクション
- **機能**：フィルタダイアログによりフィルタ条件を設定し、カードリストUIに表示するべきカードを制御する

### 15.2.2 フィルタ設定ダイアログ
- **起動**: メイン画面のフッターのフィルタボタンタップ
  - フィルタダイアログの起動時点ではフィルタリングは実行しない。
- **デザイン**:
  - ダイアログの色：レア度同様のグラデーションのかかった紫色
  - 子要素のUIの色：指定がない限り基本的に白を基調にする。
- **挙動**ダイアログを閉じた時点でその時点のフィルタ設定でカードリストを更新する  
- **構成要素**:
  - 構成要素は指定がない限りこの仕様の記述順に縦に並べる
  - **属性選択ボタン**:
    - フィルタ対象とするセル属性をボタンで並べる
    - Text、Task、Removeの3種類を横並びに配置
    - `Remove`ボタンを選択すると、除外されているセル（remove判定）された項目も含めて検索・表示する。
    - **デザイン**：端を丸めたボタンに属性名を表示。有効時は紫地に白文字、無効時は白地に灰色の文字。状態に関わらず1pxの白の枠線で囲む。
  - **キーワード抽出フィルタ**:
    - 入力欄: 検索したいキーワードを入力する。複数キーワードをスペース区で区切る事でOR検索。
    - ターゲット切り替えボタン:入力欄の横に表示。 「両方」「名前」「値」の3つの状態をサイクル切り替え、セルの名前と値のどれを検索対象にするのかを指定する。
  - **キーワード除外フィルタ**:
    -「キーワード抽出フィルタ」と同じデザインと挙動。入力されたキーワードを除外フィルタとして使用する
  - **期間フィルタ**:
    - 「年月日」単位で期間を指定する。開始日（date-from）と終了日（date-to）の2つを指定してその期間中のセルを対象とする。
    - 2つのテキストボタンを横に並べて表示し間に「～」のテキストを表示。左が開始日、右が終了日。
    - デフォルト状態でテキストボタンの表示は「-/-/-」
    - テキストボタンをタップすると日付選択ダイアログを表示し、選択された日付をテキストボタンに「YYYY/MM/DD」の形式で表示する。
    - 右側にリセットボタンを配置し、タップすると期間フィルタをリセットする。
  - **適用ボタン**:
    - **リセットボタン**: すべての条件をデフォルト（属性: Text, Taskのみ有効でremoveは無効、キーワード抽出・除外ともに空、期間リセット状態）に戻す。
    - **適用ボタン**: 現在のフィルタ設定を保存し、ダイアログを閉じる。フィルタの適用はダイアログ自体の更新判定に任せること。

### 15.2.3 デフォルト設定
- **有効属性**: `['Text', 'Task']`
- **無効属性**: `['Remove']`
- **キーワード抽出**: 空
- **キーワード除外**: 空
- **キーワードのターゲット**: 両方
- **期間**: 指定なし
- **強調表示**: 無効
- **フィルタ状態**: 無効

### 15.2.4 キーワードの強調表示
- **適用**：キーワード抽出フィルタに一致するテキストを強調表示する。
- **対象**：カードUIのプレビューテキスト、セルUIのテキスト部分で
- **強調表示**：一致するテキスト部分の背景を薄いオレンジ色に変更する
- **解除**：フィルタから抽出キーワードが削除されたら該当するテキストの強調表示も解除する

## 15.3 フィルタリングプロセス (`filterCards`)
フィルタリングはカード内に記録されたサブセル単位で判定を行い、カード単位で。
1. **無効時の挙動**: フィルタが無効でもremove判定が有効なカードは非表示。
2. **マッチング判定**:
   フィルタ処理は以下の順序で適用すること
   - **期間フィルタ**: サブセルのIDのタイムスタンプが一つでも指定期間内のカードは抽出対象
   - **属性フィルタ**: 選択された属性を1つ以上持つサブセルがを含んだカードが抽出対象
   - **キーワード除外**:
     - キーワード除外フィルタで指定されたキーワードのいずれかが、サブセルの`name`や`value`に含まれているカードが除外対象。**キーワード抽出よりもキーワード除外を優先する**。
   - **キーワード抽出**:
     - キーワード抽出フィルタで指定されたキーワードのいずれかが、サブセルの`name`や`value`に含まれているカードが抽出対象

## 15.4 データ永続化
- フィルタ設定は現在メモリ内のみで保持され、アプリの再起動（ページリロード含む）でデフォルトにリセットされる。
- **データの永続化は行わない**

