# 9. レア度仕様 (Rarity)

ログ内の「単語（セルタイトル）」の出現頻度に基づいて、情報の希少性（レア度）を自動計算するシステムです。
レア度は、ユーザーがどの情報を重視しているか（あるいは珍しい活動か）を視覚的に表現するために使用されます。

## 9.1 基本概念
- **対象**: `Card`属性および`Time`属性**以外**のすべてのセルの`name`（タイトル）。
- **頻度基準**: データベース内の最新（ID降順）から3000件のセルを対象に集計。
- **レベル**: 0.0（Common/一般的）～ 1.0（Rare/希少）の浮動小数点。
    - **出現頻度が高い**ほど、値は小さくなり（0.0に近く）Commonとなります。
    - **出現頻度が低い（または新規）**ほど、値は大きく（1.0に近く）Rareとなります。

## 9.2 計算ロジック
### 9.2.1 減衰計算
1. アプリ起動時にデータベースの最新（ID降順）から最大3000件のセルを取得します。
2. 取得した順（新しい順）にタイトルを走査し、レア度辞書（Map）を構築します。
3. 各タイトルのレア度は以下のように決定されます：
    - **初回出現時**: レア度 `1.0` (Rare)
    - **既出の場合**: 現在のレア度 × `0.97`
        - 例: 2回目出現時は `0.97`、3回目は `0.9409` ... と減衰していく。
        - これにより、頻繁に出現する単語ほどレア度が低下（0に接近）します。

※ 辞書に存在しない（集計範囲外または未出現）単語は、デフォルトで **レア度 1.0** として扱われます。
※ セルの追加・編集時には再集計を行わず、次回起動時に反映されます。

### 9.2.2 カードのレア度
カード単体のレア度は、そのカードに含まれる対象セルのレア度の**平均値**で決定されます。
- 対象セルがないカード、または計算未完了時は、デフォルトで `1.0` (Rare) となります。

## 9.3 処理フローとデータ永続化
計算コストと起動速度のバランスを取るため、以下のフローで処理されます。

1. **起動直後**: `localStorage` から前回の計算結果（辞書）を読み込み即座に適用します。
    - Key: `mylog_rarity_data_v2`
2. **バックグラウンド計算**: 
    - メインスレッドで最新3000件の集計を開始します。
    - 集計中はヘッダーのDBアイコンが紫色になり、「Calculating...」と表示されます。
3. **完了後**:
    - 新しい計算結果でメモリ上の辞書を更新し、`localStorage` に保存します。
    - 画面上のカード表示（色）を最新の状態に更新します。

## 9.4 色彩表現
レア度（0.0〜1.0）に応じて背景色の濃度が変化するグラデーションを採用しています。
データ未読み込み時や計算前は、デフォルトで**最高レア度（1.0/最も濃い）**の配色が適用されます。

- **ベースカラー (Rare / 1.0)**:
    - Start: `#667eea` (Blue-Purple)
    - End: `#764ba2` (Deep Purple)
- **ライトカラー (Common / 0.0)**:
    - ベースカラーの約60%の濃度（白とブレンドして淡くしたもの）。
- **計算式**:
    - Rare(1.0) と Common(0.0) の2つの色の間で、現在のレア度値を係数として線形補間（Linear Interpolation）を行います。
    - 値が大きいほどベースカラー（濃い紫）に近づきます。
- **スタイル**: `linear-gradient(135deg, ...)`
