# 5. カードUI (Card UI)

カードはユーザーのデータ操作の基本単位であり、複数のCellを束ねるコンテナとして機能します。

# レイアウト
- **[全体]**：垂直 (Card List内の一項目として配置)
  - **[ヘッダー]**：水平 (配置：上下・左右に展開)
    - **通常時**
    - 🏷️ タイトル (通常時のみ。左側配置)
    - 📅 生成日時 (通常時のみ。右側配置)
    **展開時**
    - 🛠️ カードツールバー (展開時のみ。右側配置)
    - ❌ 閉じるボタン (展開時のみ。右端配置)
  - **[ボディ]**：垂直 (展開時のみ)
    - 📋 セルリスト (垂直並び)
    - **[追加エリア]**：(右下)
      - ➕ セル追加ボタン (Card FAB)-フローティング
      - 🎡 属性選択メニュー (Pie Menu) - 展開時のみ

# 共通仕様
(カードコンテナ全体に関わる共通のデザイン。個別仕様「カード本体」にて詳細を記述)

# カード本体
**名称**：カード本体
**種類**：コンテナ
**用途**：複数のセルを統合し、データ操作の基本単位として機能。
**形状**：角丸（`rounded-[16px]`）、枠線なし（展開時は `ring-2 ring-white/20`）。
**寸法**：パディング `8px (p-2)`。カード間の間隔 `12px (mb-3)`（リスト配置時）。左右の余白 `16px (px-4)`（リスト配置時）。
**文字**：
  - タイトル：ボールド・大（`text-lg`）、白色（`text-white`）。
  - 生成日時：小（`text-xs`）、灰色（`text-gray-400`）。
**色彩**：
  - 背景：子セルのレア度の平均に基づく線形グラデーション（135deg）。
  - 除外時：背景 `bg-gray-500/20`、透過（`opacity-70`）。
**装飾**：シャドウ（`shadow-sm`）。
**配置**：縦並び（`flex-col`）。通常のヘッダーは `justify-between`、展開時は `justify-end`。
**状態**：
  - **通常 (Collapsed)**：タイトル、生成日時、背景を表示。クリックで展開。
    - **列挙表示 (Enum Mode)**：子要素である`Text` セルと `Task` セルのタイトルを縦に並べて表示。先頭は `text-lg/bold`、以降は `text-sm/opacity-80`。
  - **展開 (Expanded)**：ツールバー、セルリスト、FABを表示。クリックで閉じない（閉じるボタンまたはEscキーを使用）。
  - **除外 (Removed)**：背景色が変更され、テキストに打ち消し線（`line-through`）が適用される。クリック不可。
**挙動**：300msのトランジション（`transition-all`）。`Esc`キーによる折りたたみ。

# カードツールバー
**【重要】指示がない限りセルUIのソートはカードUI上のセルUIの並びを変えるものであり、カード内のデータの記録順序を変えるものではない**

**名称**：カードツールバー
**種類**：操作ツール群
**用途**：ツールバーのアイコンをまとめる
**形状**：角丸（rounded-lg）、
**寸法**：
**文字**：
**色彩**：背景：透明。
**装飾**：なし
**配置**：
  - 展開時のツールバーはカード内右上に配置。閉じるボタンの左側。
  - アイコン間隔 4px（gap-1）。
**状態**：各アイコンの状態はローカルに記録し、他のカードUIの展開時にアイコン状態とソートを適用する。また、カードUIの列挙表示時にもソートを適用する。
**挙動**：
  - 時間ソートアイコンが有効な場合は時間ソートアイコンに従いセルUIをソート
  - タスクソートアイコンが有効な場合は完了状態優先ならば他のソートを適用した上で完了タスクを先頭に集め、未完了タスクを末尾に集める
  - 手動並べ替えアイコンが有効になった場合は時間ソートアイコンとタスクソートアイコンを無効にする
  - 時間ソートアイコンかタスクソートアイコンが有効になった場合は手動並べ替えアイコンを無効にする


## ツールアイコン(共通仕様)
**名称**：ツールアイコン
**種類**：アイコン
**用途**：セルの並びを決定する
**形状**：角丸（rounded）。
**寸法**：24x24px
**文字**：詳細ラベルは極小（10px）。
**色彩**：
  - 背景：透明。
  - アクティブ時：ツールアイコン：白、ラベル文字色：白（text-white）。
  - 非アクティブ(無効)時：ツールアイコン：灰色、ラベル文字色：透明
**装飾**：なし
**配置**：アイコンは横並び、詳細ラベルはアイコンの下に中央揃え
**状態**：
  - アクティブ：並び替えを適用
  - 非アクティブ：並び替えを解除
**挙動**：
  - クリック：並び替え状態の切り替えまたは解除

### 時間ソートアイコン
**名称**：時間ソートアイコン
**種類**：
**用途**：セルの生成時間を基準とした並び替えを行う
**形状**：時計アイコンを表示
**寸法**：
**文字**：
  - 無効：なし
  - 新しい順：`New`
  - 古い順：`Old`
**色彩**：
**装飾**：
**配置**：
**状態**：
  - 無効：セルの並びに時間ソートを適用しない
  - 新しい順：セルの並びに時間ソートを適用し、生成時間の新しい順に並べる
  - 古い順：セルの並びに時間ソートを適用し、生成時間の古い順に並べる
**挙動**：無効→新しい→古い→無効の順でループしながら切り替える

### タスクソートアイコン
**名称**：タスクソートアイコン
**種類**：
**用途**：タスクセルの完了状態でセルの並び替えを行う
**形状**：`Check box`(完了優先)と`Check box outline Blank`(未完了優先)を切り替え
**寸法**：
**文字**：なし
**色彩**：
**装飾**：
**配置**：
**状態**：
  - 無効：タスクセルの並びを変更しない
  - 未完了優先：タスクセルの並びを未完了優先で変更
  - 完了優先：タスクセルの並びを完了優先で変更
**挙動**：無効→完了優先→未完了優先→無効の順でループしながら切り替える

### 手動並べ替えアイコン　(実装予定)
**名称**：手動並べ替えアイコン
**種類**：
**用途**：
**形状**：
**寸法**：
**文字**：
**色彩**：
**装飾**：
**配置**：
**状態**：
**挙動**：　まだ実装しない

# セル追加ボタン (Card FAB)
**名称**：セル追加ボタン (Card FAB)
**種類**：フローティングアクションボタン
**用途**：カード内へのセル新規追加。
**形状**：正円（`rounded-full`）。
**寸法**：`60x60px`、アイコン `28px`。
**文字**：なし。
**色彩**：背景 紫色（`bg-purple-600`）、白色文字。
**装飾**：白色のシャドウ（`shadow-white/50`）。
**配置**：ボディ右下（`bottom-16`, `right-16`）。スクロールに併せてフローティング。
**状態**：アクティブ時にスケール（`active:scale-95`）。
**挙動**：
  - **短押し**：デフォルトの `Text` 属性セルを追加。
  - **長押し**：`10ms` 以上の維持でパイメニューを表示。

# セル追加パイメニュー (Pie Menu)
**名称**：セル追加パイメニュー (Pie Menu)
**種類**：コンテキストメニュー項目
**用途**：追加するセルの属性選択。
**形状**：角丸（`rounded-xl`）。
**寸法**：`48x48px (w-12 h-12)`、アイコン `24px`。
**文字**：なし。
**色彩**：背景 淡紫色（`bg-purple-200`）、白色文字。
**装飾**：シャドウ（`shadow-md`）。ホバー時にスケール `1.1倍`、リング（`ring-2 ring-white/50`）。
**配置**：
  - **Task**: FABの上方（`bottom-16`）。（アイコン: `check_box`）
  - **Text**: FABの左方（`right-16`）。（アイコン: `article`）
**状態**：ホバー/選択状態で視覚的に強調。
**挙動**：マウスアップ時に該当属性のセルを追加しメニューを閉じる。

# ロジック
## レア度算出
- カード内の `Time` 属性以外のセルのレア度平均（0.0-1.0）を算出。
- 算出した平均値を基に、`Rare (#667eea, #764ba2)` と `White` をブレンドしたグラデーション背景を生成。
- 子要素がない、または `Time` セルのみの場合はデフォルト値（1.0）を使用。

## タイトル決定
- カード内セルのうち、`Time` 属性以外の最初のセルの名称（`N`）をタイトルのデフォルトとして表示。

## カードの自動初期化
- 新規作成時に `Time Cell`（作成時刻）とデフォルトの `Text Cell`（空）を自動的に追加する。

## スクロール挙動
- カード展開時、`react-virtuoso` を通じて対象カードが画面最上部に位置するようにスムーズスクロールを実行。
- ヘッダー・フッターの表示状態に合わせて `scrollPadding` を動的に調整。

## 入力学習
- セル保存時に `CellTitleEstimation` への学習（learn）を実行し、次回の候補推論に利用。

