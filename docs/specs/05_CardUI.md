# 5. カードUI (Card UI)

カードはユーザーのデータ操作の基本単位であり、複数のCellを束ねるコンテナとして機能します。

## 5.1 基本構成
- **ID**: Cardセルの`id`を使用
- **Value**: 含まれるCellの`id`のリスト（スペース区切り）

## 5.1.1 デフォルトの子要素セル
Cardの新規作成時に下記のセルデータをCardの子要素として生成しCardのValueに登録する。その後CardUIの表示に反映する。
- **Time Cell**: Cardの作成時にCardの作成時刻を記録したTime属性のセルを自動追加する
  - Time Cellの`name`には文字列で`Time`を指定、`value`には現在時刻を指定
- **Text Cell**: Cardの作成時にデフォルトの`Text`属性のセルを自動追加する
  - Text Cellの`name`と`value`には空文字を指定
- Time Cellを追加したあとText Cellを追加する
- IDが時間順になるようにCard Cell、Time Cell、Text Cellの順に作成し、それぞれの作成タイミングの間で1msの待機時間を設ける



## 5.1.2 カードUIの状態
カードUIは展開と折りたたみを可能にする
**展開**
  - カード展開時はカードに属するセルをリスト表示し、セルの追加・編集が可能になる
**折りたたみ**
  - カードUIを折りたたんだ時点で`name`が空のTaskセル、`name`と`value`が空のTextセルが存在する場合はカードから削除する
  - カードを折りたたんだ時点でカードに関連するセルの情報をデータベースで更新する

## 5.2 ユーザー操作
- **クリック (Tap)**:
  - カードを展開し、詳細・編集画面を表示します。
  - 展開はインラインで行われ、画面遷移はしません（Expanded Card）。
- **長押し / 右クリック**:
  - カードの除外（削除）または復元の確認ダイアログを表示します。

## 5.3 表示要素
## 5.3.1 折りたたみ状態
**プレビューテキスト**
- カードに含まれるセルの`name`をカードUIに表示する
- `Time`属性セルはプレビューテキストの対象から除外する
- **通常表示**：カードに記録されている先頭セルのタイトルを表示する。この時**5.3.2の並べ替えアイコンの設定は無視する**
- **列挙表示**：カードに属するセルのタイトルを並べて表示する。この時セルの並びは**5.3.2の並べ替えアイコンの設定に準拠する**

**生成日時**
- 右上にはそのCardの生成時刻としてCardセルの`id`から生成時間を取得し表示する
- 生成時間は薄い灰色で表示する

## 5.3.2 展開状態
- 展開時はカードに記録されているセルの編集が可能になる
-カード展開時にはカードの生成時間は表示しない

### 5.3.2.1 ツールアイコン
- **ヘッダー高さ**: 28px
- **アイコンサイズ**: 20px × 20px
- **アイコン間隔**: 4px
- **配置**：カードUIの右上に配置
- **機能**：
  - 主にセルUIの並びを制御するための機能アイコン群(ただし**Timeセルは並べ替え対象外**とし常に先頭に表示すること)
- **【重要】ツールアイコンの機能では明確な言及がない限りCardセルに記録されているセルIDの並びは変更せず、UI上の見た目の並びだけを変更する**。この仕様は徹底すること。
- **記録**：ツールアイコンの状態はlocalStorageに記録され、ツールアイコンの状態やソート条件は他のカードUIにも共有しその表示に適用する
#### 5.3.2.1.1 閉じるボタン
- 右上には閉じるボタンが表示され、押すと折りたたみ状態に戻る
  - 閉じるボタンは白地の丸いアイコンに薄い灰色のバツ印を表示する
  - Escキーやページ戻り操作でも折りたたみ状態に戻る

#### 5.3.2.1.2 生成時間ソートボタン
- **デザイン**：白色のソートアイコンを閉じるボタンの左側に表示する
- アイコンをタップすると表示されているセルUIをソートする
- **ソートの種類**：セルUIのソートは以下の機能を持つ
  - **無効(デフォルト)**：白色のバツ印付きのソートアイコン。カードに記録されている順番でセルUIをソートする。
  - **古い順**：白色のソートアイコン。各セルの`id`から取得した生成時間の古い順でソートする
  - **新しい順**：白色の逆さまのソートアイコン。各セルの`id`から取得した生成時間の新しい順でソートする


#### 5.3.2.1.3 タスクソート
- 白色のタスクソートを生成時間ソートアイコンの左側に表示する
- アイコンをタップすると下記の3つの状態を実現する
  - **無効(デフォルト)**：白色のバツ印付きのチェックボックスアイコン。タスクソートを無効化した状態。アイコンにバツ印を表示。タップすると未完了タスク優先に切り替わる
  - **未完了タスク優先**：白色の空のチェックボックスアイコン。Taskセルの`value`が未完了状態のセルを優先してソートする。生成時間順にソートしたうえで未完了タスクを先頭に集め、完了タスクを末尾に集める。タップすると完了タスク優先に切り替わる。
  - **完了タスク優先**：白色のチェックマーク付きのチェックボックスアイコン。Taskセルの`value`が完了状態のセルを優先してソートする。生成時間順にソートしたうえで完了タスクを先頭に集め、未完了タスクを末尾に集める。タップすると無効に切り替わる。

#### 5.3.2.1.4 手動並べ替えアイコン
- **配置**：白色の並べ替えアイコン(↑↓)をタスクソートの左側に表示する
- **条件**：
  - 生成時間ソートアイコンかタスクソートのどちらかが有効になったら手動並べ替えアイコンは無効にする。
  - 手動並べ替えアイコンを有効にしたら生成時間ソートアイコンとタスクソートを無効にする。
  - カードUIを閉じた時点で手動並べ替えアイコンの状態を無効に更新する
- **状態**：
  - **無効**：白のバツ印つきの並べ替えアイコンを表示する。セルUIの並び替えを無効化した状態でセルUIの手動での並び替え機能を無効化する。タップすると有効に切り替わり、生成時間ソートアイコンとタスクソートを無効化し、localStrageに記録しているセルUIの並び替え状態を無効に更新する。
  - **有効**：白の並べ替えアイコン(↑↓)を表示する。セルUIの並び替えを有効化した状態。タップすると無効に切り替わる。
- **セルデータ並べ替え機能**
  - **【重要】この機能は`Card`セルの`value`に記録されている子要素セルの`id`値の記録順序を直接変更する機能**である。
  - **ただし`Time`セルは並べ替えの対象外**とし常に`Card`の`value`先頭に記録する
  - **条件**：並べ替えアイコンとタスクソートが両方とも無効状態の時のみ動作する
  - **挙動**：
    - セルUIを長押しで浮き上がらせ、ドラッグしてセルUIの順序を入れ替え、セルUIを離すと並びを確定する
    - 並びが確定したら`Card`セルの`value`に記録されているセルの`id`値の記録順序を確定した並び順序に従い変更する。**【重要】破壊的操作であるためこの処理のコードは入念に設計し、許可がない限り変更してはいけない**


### 5.3.2.3 セルUIリスト
カードに記録されているセルIDを元に対応するセルUIを生成しリスト表示する



### 5.3.2.4 セル追加ボタン(フローティングボタン)
- **サイズ**: 60px × 60px
- **配置**: 右端から 16px、下端から 76px (位置固定)

#### 5.3.2.4.1 セル追加ボタンの挙動
- **デザイン**：セル追加ボタンは丸いボタンで薄い紫の背景に白い十字マークを表示する。
-**挙動**
- セル追加ボタンはフローティングボタンで画面にあわせてカードUI内を移動し、フッターやキーボードに隠れないようにする。
- **セルの追加**：セル追加ボタンを押してから離したらそのCardセルに新規のセルを追加する
  - **セルタイトルの推定**：追加された新規セルには推定されたセルタイトルが自動入力される
  - **フォーカス**：セルを追加すると**追加したセルのタイトルにフォーカス**しセルタイトルを全選択した状態でテキスト末尾に入力カーソルを置く
  - **セルUIの追加位置**：セルUIの追加位置はその時点のソート条件に依存する
    - 手動並べ替え機能が有効(生成時間ソートとタスクソートが無効)な時は、Cardセルの`value`に記録されている順序の位置に従い追加する
    - 手動並べ替え機能が無効かつ、生成時間順のソートが無効、タスクソートも無効な時は、Cardセルの`value`に記録されている順序の位置に従い追加する
    - 手動並べ替え機能が無効かつ、生成時間順のソートまたはタスクソートが有効な時はソート位置に従い追加する


#### 5.3.2.4.2 セル追加ボタンのパイメニュー
-**パイメニューの挙動**
  - セル追加ボタンを10ms以上長押しするとパイメニューが表示される
  - ドラッグして各メニュー項目上で離すか、選択せずに追加ボタンを離すとメニューは閉じる
- **パイメニューの項目**
  - パイメニューには`Text`と`Task`属性の選択ボタンを表示し、選択した属性のセルUIをカードに新規追加する
  - パイメニューは追加ボタンの左側に`Text`を、上側に`Task`のボタンを配置する
  - **デザイン**：
  - パイメニューの項目は角を丸めた四角型で薄い紫の背景
  - `Text`項目にはメモを表すモノクロのアイコンを白色で表示する
  - `Task`項目にはチェックリストを表すモノクロのアイコンを白色で表示する

## 5.4 カードUIのデザイン

**カード内パディング**: 12px (カード外枠とセルUIの間隔)
**プレビュー** ：含まれるテキストコンテンツを表示し折り返しを許容。文字サイズは固定。
**背景色** : 各Cellのレア度の平均値に基づいて算出された色。Card Cell と Time Cellのレア度は平均値の計算に含まない。
**外枠**：外枠は表示しない。
**除外状態** :削除済み（`remove`設定あり）の場合、薄いグレー背景に設定しプレビューテキストを打ち消し線で表示 

## 5.5 パフォーマンス
- **仮想スクロール (Virtual Scroll)**:
  - 大量のログをスムーズに表示するため、画面内に見える範囲のカードのみを描画します。
