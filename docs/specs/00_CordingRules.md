# 0 Antigravity アプリケーション実装ガイドライン (Refined)
本プロジェクトは Next.js 16 (App Router) + PWA + Local-First (Dexie.js) 構成において、Antigravity（AI）による解釈性・保守性およびトークン効率（コンテキスト最適化）を最大化することを目的とする。

## 0.0 仕様の厳守と型安全性の絶対視 (Strict Adherence & Type Safety)
仕様の正当性: 実装は .md 仕様書を正とする。矛盾がある場合は推測で実装せず、必ず確認を行う。

Single Source of Truth (SSOT):

データ構造の定義は Zod Schema を正とする。TypeScriptの型定義は z.infer を通じてZodから生成し、型定義とバリデーションロジックの二重管理（不整合）を防ぐ。

DBスキーマは Dexie.js の定義を正とする。

リンター/フォーマッタ準拠: Biome/ESLint 等の静的解析エラーを許容しない。AIがエラー修正にトークンを浪費しないよう、クリーンな状態を保つ。

## 0.1 構造化と粒度 (Semantic Granularity & Collocation)
機能単位のコロケーション (Feature-Sliced Design):

Next.js App Router の特性に合わせ、機能に関連するコンポーネント、フック、型定義は可能な限り app/ 以下の同一ディレクトリ（または features/）に近接させる。

これにより、RAG（検索）がディレクトリ単位でコンテキストを取得した際、関連情報が欠落するのを防ぐ。

ファイル分割の基準:

1ファイル 100〜200行を目安とするが、「Server Component と Client Component の境界」 での分割を最優先する。

"use client" ディレクティブを持つファイルは、インタラクションを含む最小限の範囲に留め、ロジックの肥大化を防ぐ。

## 0.2 独立性と自己完結性 (Context Autonomy)
明示的な依存関係:

ワイルドカードインポート (import *) および バレルファイル (index.ts による再エクスポート) の使用を原則禁止する。

バレルファイルはAIが依存関係を追跡する際、不要なモジュールまでコンテキストに読み込ませる原因となり、トークン効率を悪化させるためである。

純粋性と副作用の排除:

Reactコンポーネントおよびフックは、外部スコープへの依存を持たず、Propsや引数のみで動作が決定する設計とする。

グローバルステート（Zustand/Context）へのアクセスは専用のカスタムフックに閉じ込め、コンポーネント自体がストアの実装詳細を知らない状態を維持する。

## 0.3 定義と実装の分離 (Skeleton & Implementation)
インターフェース先行:

複雑なロジック（Dexie.jsのクエリやTanStack Queryのfetcher等）を実装する際は、先に関数のシグネチャ（引数と戻り値の型）とJSDocを定義する。これによりAIは実装の中身を読まずとも、インターフェース定義だけで他のモジュールとの結合を推論できる。

UIとロジックの分離 (Container/Presentation Pattern):

データの取得・加工（TanStack Query/Dexie）を行う層と、表示（Tailwind CSS）を行う層を明確に分ける。

Tailwind CSS 4 のクラス記述は長くなりやすいため、JSXの見通しを良くするために、複雑なスタイリングは別コンポーネント化するか、可読性を損なわない範囲で適切に改行する。

## 0.4 高密度な記述とドキュメンテーション (Token Density & Context)
Why/Context指向のコメント:

「何をしているか（What）」はコード自体が語るためコメント不要。「なぜそうしたか（Why）」、特に「Next.jsのキャッシュ仕様やPWAのオフライン要件」に関連する意図を重点的に記述する。

JSDocによる意味付け:

エクスポートする関数や型には必ず JSDoc (/** ... */) を付与する。これは人間用であると同時に、AIがコードの役割を理解するための最強の手がかりとなる。

デッドコード・装飾の完全排除:

使用していない console.log、コメントアウトされた旧コード、機能に関与しない装飾ラインは即時削除する。これらは「AIの幻覚（ハルシネーション）」の主因となる。