# セルタイトル推定仕様

## 1. 概要
ユーザーが新しいセルを追加する際、直前のセルのタイトルに基づいて、次に入力される可能性が高いタイトルを自動的に推定して補完候補とする機能の仕様です。
これにより、連続したデータ入力（例：「日付」→「天気」→「気温」のような定型パターン）の効率化を図ります。

## 2. アルゴリズム
基本的には単純な **1次マルコフ連鎖（Markov Chain）** と **頻度分析** を組み合わせています。
直前のタイトル $T_{n-1}$ が与えられたとき、過去のデータから $T_{n-1}$ の次に最も頻繁に出現したタイトル $T_{n}$ を推定値とします。

### 2.1 データ構造
内部的には以下のマップ構造で遷移頻度を保持します。

```
Map<PrevTitle, Map<NextTitle, Count>>
```

- **PrevTitle**: 遷移元のタイトル（直前のセルのタイトル）
- **NextTitle**: 遷移先のタイトル（現在のセルのタイトル）
- **Count**: その遷移が出現した回数

### 2.2 推定ロジック
1. 入力として「直前のセルのタイトル ($T_{prev}$）」を受け取ります。
2. データ構造から $T_{prev}$ をキーとして検索します。
3. 候補が存在する場合：
    - $T_{prev}$ に続くタイトルの中で、**出現回数 (Count)** が最も多いタイトルを返します。
4. 候補が存在しない場合（未知のパターンの場合）：
    - $T_{prev}$ をそのまま返します（前回と同じタイトルが続くと仮定するフォールバック）。

## 3. 学習プロセス（集計）

### 3.1 初期化時 (Hybrid)
アプリケーション起動時に、高速化と最新データの反映を両立するため、以下の2段階の処理を行います。

1.  **キャッシュ読み込み（即時）**:
    *   前回起動時に計算・保存された集計データ（`localStorage`）を読み込み、即座に利用可能にします。
2.  **バックグラウンド再集計（Background Calculation）**:
    *   データベースから**IDが新しい順に**データの取得を開始します。
    *   TitleEstimatorは、取得したデータのうち**先頭3000件**（対象となるセル数）のみを用いて、最新の遷移頻度を再計算します。
    *   この再計算中は、1で読み込んだ既存のキャッシュデータを利用して推定を行います。
    *   集計が完了（3000件到達、または全件走査終了）した時点で、新しい集計結果にメモリ上のデータを置き換え、次回用に保存します。

### 3.2 実行時更新
カードの追加やセルの変更に伴う逐次更新（インクリメンタル更新）は行いません。
次回起動時の再集計まで、実行中のロジックは固定されます。

## 4. 永続化
集計データは次回起動時の高速化のため、ブラウザの `localStorage` に保存されます。
- **Key**: `TitleEstimator_Data`
- **Format**: `Array<[PrevTitle, Array<[NextTitle, Count]>]>` (Map entries serialized as JSON arrays)
- **Timing**: 初期化時のバックグラウンド集計完了時に保存されます。

## 5. UI連携
- **DB読み込み中表示**: バックグラウンドでの再集計処理中は、DBアイコン（`#db-status-btn`）の色が変わり（紫）、**「Estimating」** と表示されます。

