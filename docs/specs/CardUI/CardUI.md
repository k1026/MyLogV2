# 5. カードUI (Card UI)

カードはユーザーのデータ操作の基本単位であり、複数のCellを束ねるコンテナとして機能します。

# レイアウト
- **[全体]**：垂直 (Card List内の一項目として配置)
  - **[ヘッダー]**：水平 (配置：上下・左右に展開)
    - **通常時**
    - 🏷️ タイトル (通常時のみ。左側配置)
    - 📅 生成日時 (通常時のみ。右側配置)
    **展開時**
    - 🛠️ カードツールバー (展開時のみ。右側配置)
    - ❌ 閉じるボタン (展開時のみ。右端配置)
  - **[ボディ]**：垂直 (展開時のみ)
    - 📋 セルリスト (垂直並び)
    - **[追加エリア]**：(右下)
      - ➕ セル追加ボタン (Card FAB)-フローティング
      - 🎡 属性選択メニュー (Pie Menu) - 展開時のみ

# 共通仕様
(カードコンテナ全体に関わる共通のデザイン。個別仕様「カード本体」にて詳細を記述)

# カード本体
**名称**：カード本体
**種類**：コンテナ
**用途**：複数のセルを統合し、データ操作の基本単位として機能。
**形状**：角丸（`rounded-[16px]`）、枠線なし（展開時は `ring-2 ring-white/20`）。
**寸法**：パディング `8px` (`p-2`)。カード間の間隔 `12px` (`mb-3`)（リスト配置時）。左右の余白 `16px` (`px-4`)（リスト配置時）。
**文字**：
  - タイトル：ボールド・18px（`text-lg`）、白色（  #ffffffff  ）。
  - 生成日時：12px（`text-xs`）、灰色（  #9ca3afff  ）。
**色彩**：
  - 背景：子セルのレア度の平均に基づく線形グラデーション（135deg）。
  - 除外時：背景  #6b728033  （`bg-gray-500/20`）、透過（`opacity-70`）。
**装飾**：シャドウ（`shadow-sm`）。
**配置**：縦並び（`flex-col`）。通常のヘッダーは `justify-between`、展開時は `justify-end`。
**状態**：
  - **通常 (Collapsed)**：タイトル、生成日時、背景を表示。クリックで展開。
    - **列挙表示 (Enum Mode)**：子要素である`Text` セルと `Task` セルのタイトルを縦に並べて表示。先頭は 18px/bold (  #ffffffff  )、以降は 14px/opacity-80 (  #ffffffcc  )。
  - **展開 (Expanded)**：ツールバー、セルリスト、FABを表示。クリックで閉じない（閉じるボタンまたはEscキーを使用）。
  - **除外 (Removed)**：背景色が変更され、テキストに打ち消し線（`line-through`）が適用される。クリック不可。
**挙動**：300msのトランジション（`transition-all`）。`Esc`キーによる折りたたみ。

# カードツールバー
**【重要】指示がない限りセルUIのソートはカードUI上のセルUIの並びを変えるものであり、カード内のデータの記録順序を変えるものではない**

**名称**：カードツールバー
**種類**：操作ツール群
**用途**：ツールバーのアイコンをまとめる
**形状**：角丸（rounded-lg）
**寸法**：高さ 32px、パディング 8px (`px-2`)
**色彩**：背景：透明（  #ffffff00  ）
**装飾**：なし
**配置**：
  - 展開時のツールバーはカード内右上に配置。閉じるボタンの左側。
  - アイコン間隔 4px（`gap-1`）。
**状態**：各アイコンの状態はグローバルに記録し、全カードで共通のソート設定を適用する。
**挙動**：
  - **時間ソート**：生成時間に基づいてソート（`desc`：新しい順 / `asc`：古い順）。
  - **タスクソート**：タスク属性を持つセルをグループ化して表示（`complete`：完了優先 / `incomplete`：未完了優先 / `none`：解除）。他のソート（時間など）を適用した上で、グループ内での順序を維持する。
  - **手動並べ替え**：他の自動ソート（時間、タスク）を無効にする。
  - いずれかの自動ソート（時間 or タスク）を有効にした場合：手動並べ替えを無効にする。

## ツールアイコン(共通仕様)
**名称**：ツールアイコン
**種類**：アイコン
**用途**：セルの並びを決定する
**形状**：角丸（rounded）。
**寸法**：28x28px (`w-7 h-7`)
**文字**：詳細ラベルは 10px。
**色彩**：
  - 背景：透明。
  - アクティブ時：ツールアイコン：  #ffffffff  、ラベル文字色：  #ffffffff  。
  - 非アクティブ時：ツールアイコン：灰色（  #ffffff80  ）、ラベル文字色：透明（`opacity-0`）
**装飾**：なし
**配置**：アイコンは垂直並び（`flex-col`）、中央揃え。
**状態**：
  - アクティブ：並び替えを適用
  - 非アクティブ：並び替えを解除
**挙動**：
  - クリック：並び替え状態の切り替えまたは解除
  - ホバー：1.05倍にスケール (`hover:scale-105`)

### 時間ソートアイコン
**名称**：時間ソートアイコン
**種類**：トグルボタン
**用途**：セルの生成時間を基準とした並び替えを行う。
**形状**：`schedule` (時計) アイコンを表示。
**寸法**：28x28px
**ラベル**：
  - 新しい順：`NEW`
  - 古い順：`OLD`
**状態**：
  - `desc`（新しい順）：生成時間の新しい順に並べる
  - `asc`（古い順）：生成時間の古い順に並べる
**挙動**：`desc` (NEW) ↔ `asc` (OLD) の2状態で切り替え。

### タスクソートアイコン
**名称**：タスクソートアイコン
**種類**：トグルボタン
**用途**：タスクセルの完了状態でグループ化を行う。
**形状**：
  - `complete` or `none` 時：`check_box`
  - `incomplete` 時：`check_box_outline_blank`
**寸法**：28x28px
**ラベル**：
  - 完了優先：`DONE`
  - 未完了優先：`TODO`
**状態**：
  - `none` (解除)：タスクによるグループ化を行わない
  - `complete` (完了優先)：他のソートを適用した上で、完了タスク、未完了タスク、非タスクセルの順で配置する
  - `incomplete` (未完了優先)：他のソートを適用した上で、非タスクセル、未完了タスク、完了タスクの順で配置する
**挙動**：`none` → `complete` (DONE) → `incomplete` (TODO) → `none` の順でループ。

### 手動並べ替えアイコン
**名称**：手動並べ替えアイコン
**種類**：トグルボタン
**用途**：自動ソートを解除し、手動での並び替え（ドラッグ＆ドロップ用）モードに切り替える。
**形状**：`swap_vert` アイコンを表示。
**寸法**：28x28px
**ラベル**：`MOVE`
**状態**：有効 (`isManualSort`: true)、無効 (false)
**挙動**：クリックで有効/無効を切り替え。有効時は時間・タスクソートを強制解除（`none`）する。

# セル追加ボタン (Card FAB)
**名称**：セル追加ボタン (Card FAB)
**種類**：フローティングアクションボタン
**用途**：カード内へのセル新規追加。
**形状**：正円（`rounded-full`）。
**寸法**：60x60px、アイコン 28px。
**文字**：なし。
**色彩**：背景 紫色（`bg-purple-600`：  #9333eaff  ）、白色文字。
**装飾**：白色のシャドウ（`shadow-white/50`）。
**配置**：ボディ右下（`bottom-16`, `right-16`）。
**状態**：アクティブ時にスケール（`active:scale-95`）。
**挙動**：
  - **短押し**：デフォルトの `Text` 属性セルを追加。
  - **長押し**：10ms 以上の維持でパイメニューを表示。

# セル追加パイメニュー (Pie Menu)
**名称**：セル追加パイメニュー (Pie Menu)
**種類**：コンテキストメニュー項目
**用途**：追加するセルの属性選択。
**形状**：角丸（`rounded-xl`）。
**寸法**：48x48px (`w-12 h-12`)、アイコン 24px。
**文字**：なし。
**色彩**：背景 淡紫色（`bg-purple-200`：  #e9d5ffff  ）、白色文字。
**装飾**：シャドウ（`shadow-md`）。ホバー時にスケール 1.1倍、リング（`ring-2 ring-white/50`）。
**配置**：
  - **Task**: FABの上方（`bottom-16`）。（アイコン: `check_box`）
  - **Text**: FABの左方（`right-16`）。（アイコン: `article`）
**状態**：ホバー/選択状態で視覚的に強調。
**挙動**：マウスアップ時に該当属性のセルを追加しメニューを閉じる。

# ロジック
## レア度算出
- カード内の `Time` 属性以外のセルのレア度平均（0.0-1.0）を算出。
- 算出した平均値を基に、`Rare ( #667eeaff ,  #764ba2ff )` と `White` をブレンドしたグラデーション背景を生成。
- 子要素がない、または `Time` セルのみの場合はデフォルト値（1.0）を使用。

## タイトル決定
- カード内セルのうち、`Time` 属性以外の最初のセルの名称（`N`）をタイトルのデフォルトとして表示。

## カードの自動初期化
- 新規作成時に `Time Cell`（作成時刻）とデフォルトの `Text Cell`（空）を自動的に追加する。

## スクロール挙動
- カード展開時、`react-virtuoso` を通じて対象カードが画面最上部に位置するようにスムーズスクロールを実行。
- ヘッダー・フッターの表示状態に合わせて `scrollPadding` を動的に調整。

## 入力学習
- セル保存時に `CellTitleEstimation` への学習（learn）を実行し、次回の候補推論に利用。


