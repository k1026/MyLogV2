# CardListUI 実装計画

`docs/specs/07_CardListUI.md` に基づき、メインビューとなる `CardListUI` を実装する。既存の `page.tsx` の単純な表示を置き換え、大量のデータを扱える高機能なリスト表示を実現する。

## 1. 要件定義

### 1.1 基本構成
- **配置**: ヘッダーとフッターの間（`page.tsx`のメインコンテンツエリア）。
- **表示モード**: リストビュー（1列）のみ。

### 1.2 データ管理
- **ソース**: IndexedDB (User Store) から `attribute: 'Card'` を抽出。
- **読み込み戦略**:
  - **初期ロード**: 最初の1000件のみ読み込み、UI描画とRarity計算を開始。スプラッシュスクリーン解除。
  - **バックグラウンドロード**: 残りを1000件ずつ非同期で読み込み、メモリ（State）に追加。
- **ソート**: タイムスタンプ降順（デフォルト）。編集/追加時の最適化（リスト全体の再ロードを避ける）。

### 1.3 仮想スクロール (Virtual Scroll)
- **描画範囲**: 常に90件（前30 + 表示30 + 後30）のみDOMに保持。
- **スクロール**: スクロール位置に応じて描画範囲を更新。

### 1.4 インタラクション
- **展開時**:
  - 選択したカードの上端を画面上部に合わせる（スクロール調整）。
  - リストのスクロール範囲を、そのカードの高さ分に制限する（他のカードを見えなくする感覚）。
  - リストの更新（再ソートや再描画）を一時停止。
- **折りたたみ時**:
  - 元の位置に戻る、あるいはリストの整合性を保つ。
  - パフォーマンス（スクロール位置維持）を重視。

### 1.5 その他
- **Empty State**: データなし/フィルタ結果なし時の表示。
- **Loading**: 1秒以上の処理でローディング表示。

## 2. 実装計画 (TDD / Step-by-Step)

### Step 1: データ取得フックの実装 (`useCardList`)
IndexedDBからの段階的読み込みロジックを実装する。
1. **`app/hooks/useCardList.ts` 作成**:
   - `initialLoad` (1000件) と `backgroundLoad` (残り) を実装。
   - テスト: モックDBを使用し、1000件取得後に残りが徐々に追加されるか検証。
   - フィルタリング機能の基礎も含める。

### Step 2: CardList コンポーネントと仮想スクロールの基礎
仮想スクロールのロジック（ウィンドウ制御）を実装する。
1. **`app/components/CardList/CardList.tsx` 作成**:
   - スクロールイベントを監視し、`visibleRange` (start, end) を計算。
   - 仕様通り「90件」単位での制御を実装。
2. **`app/components/CardList/CardList.test.tsx`**:
   - 大量のダミーデータを与え、DOMには90件しか描画されていないことを確認。

### Step 3: カードレンダリング
1. **Card統合**:
   - 既存の `Card` コンポーネントをリストアイテムとしてレンダリング。

### Step 4: インタラクション制御 (展開・スクロール制限)
カード展開時の特殊なスクロール挙動を実装する。
1. **Scroll Lock & Positioning**:
   - カード展開(`onExpand`)時に `scrollTo` で位置合わせ。
   - `overflow: hidden` またはコンテナサイズ制限でスクロールをロック。
2. **リスト更新停止**:
   - 展開中は `useCardList` からの更新反映をスキップするフラグ管理。

### Step 5: メインページへの統合と仕上げ
1. **`app/page.tsx` 修正**:
   - 既存の単一 `Card` 表示を `CardList` に置き換え。
   - ヘッダー/フッターとのレイアウト調整。
2. **Rarity連携**:
   - 初期ロード完了時に Rarity 計算が走ることを確認。
3. **Empty State & Loading**:
   - 「データがありません」表示とローディングスピナーの実装。

## 3. 検証項目
- 1万件程度のダミーデータを用意し、スクロールがスムーズか。
- カード展開時に画面がガタつかずに位置合わせされるか。
- バックグラウンド読み込み中にUI操作が可能か。
